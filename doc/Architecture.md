# Architecture

BaudEngine (Baud for short) is a distributed document database for elastic storage and flexible search.

## Data Model

Field, Entity, Edge, Space, DB

Each entity has an internal 'Unique ID' (UID) generated by the system, which is unique aross the entire system. 

Entities as documents: UID -> Fields

TODO: support graph - Edges as documents: (UIDi, UIDj) -> Fields

Field: name -> a typed value or a sorted array of values

Any field can be indexed and morever full-text search is a first-class citizen. 

* Flexible partitioning policies

each space has a field as the partition key

## Overview

BaudEngine is a multi-datacenter distributed system. 

However, it can be run in the single-datacenter mode.  

### components

master, raft replication for high availability

partitionserver (PS), 'writer-role' or 'reader-role'

router

### software stack

* cluster management

conainer-native - baud runs on Kubernetes clusters

each DB is allocated with its own set of PS across different datacenters (zones). 

each zone has a group of routers which are shared by all the applications. 

* BaudStorage

BS is mounted to store partition data (sorted key-value files and WAL) 

### partitioning 

db -> entity or edge space -> partition -> slot

partition = slot id range

slotID = hash func of the partitioning field to a uint32

### replication

* cross-zone replication

Each partition has a Raft state machine located in three 'writer-role' partitionservers of different zones. Actually the writer-role partitionservers run the 'multi-raft' protocol. 

* within-zone replication

In any zone, a partition can have any number of read-only replicas, which are served by the 'Reader-Role' partitionservers reading the underlying Baudstorage files. 

### re-sharding

Note that all the partition data is persistent on the BaudStorage distributed filesystem - actually BaudEngine is a pure computing system seperated with storage. 

So we leverage it to do partition splitting in an easier way. 

### scalability guarantee

One Baud cluster can host one to thousands of databases; 
one DB can host billions of spaces;
one space can host unlimited number of objects;

## Master

three/five/.. BM instances form a replicated BM service, or leverage a distributed coordination service like etcd/consul to store the metadata of Baud itself. 

we currently choose the former approach. 

* e.g. Start a master via cmd shell,

host2:$ baud -cm -http-addr host2:5001 -raft-addr host2:5002 -topo http://host1:5001 -data ~/node


### data structures

* database metadata

db (name -> id): serving zones, PS nodes

space (name -> id): entity or edge

partition (slot id range of (source) entity uid) : entity or edge

* cluster topo metadata

Zones (i.e. Datacenters, Cells): each zone has a DCOS/Kubernetes interface to allocate PS nodes and router nodes. 

master nodes - cross at least 3 zones

ps node - which zone it is located at and which DB it serves

router node - which zone 

### persistence

marshalled and written to the underlying key-value store

### key operations

* Create a Space

* Split a Partition

* Merge Partitions

the reverse process of split

* PS metrics reporting

* Router metrics reporting


## PS

there are two PS roles, i.e. two modes of running instances: 

* the writer role. participating multi-raft, a raft statemachine per partition, and logging the raft operations locally 

* the reader role. just reading from BaudStorage to serve partition read-only requests

### partition data store

Each partition has a single key-value storage engine for both documents and indexes, which is persisted onto the Baudstorage datacenter filesystem

* fields

(UID, fieldName) -> a single or multiple packed values of the field;

* posting lists

(fieldName, term, UID) -> WDF (within-document frequency)

* position lists

(fieldName, UID, term) -> position list


### Synonym Table

term synonyms are stored as a file of Baudstorage and loaded by PS for document analysis.

### Key Operations


## Router

## Search

### Ranking

## Manageability

Ops Center

Dashboard

### Monitoring

cluster-level statistics

space-level info

individual nodes

GC

SlowLog

### Deployment and Configration


### Upgrade


## Applications

### document databases

### search engine

### social backend

email

messaging

blogging



